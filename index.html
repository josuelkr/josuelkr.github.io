<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Comparador GPT + PDF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 900px;
      background: #020617;
      border-radius: 18px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
      border: 1px solid #1f2937;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .title {
      font-size: 18px;
      font-weight: 600;
    }

    .subtitle {
      font-size: 13px;
      color: #9ca3af;
    }

    .key-box {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .key-input {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #374151;
      padding: 6px 10px;
      font-size: 12px;
      color: #e5e7eb;
      min-width: 220px;
    }

    .key-input:focus {
      outline: none;
      border-color: #6366f1;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      background: #4f46e5;
      color: white;
      font-weight: 500;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .status-pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      color: #9ca3af;
    }

    .status-ok {
      color: #22c55e;
      border-color: #22c55e33;
      background: #022c2233;
    }

    .status-warn {
      color: #fbbf24;
      border-color: #facc1533;
      background: #451a0333;
    }

    .row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .hint {
      font-size: 11px;
      color: #9ca3af;
    }

    .hint a {
      color: #818cf8;
      text-decoration: none;
    }

    .hint a:hover {
      text-decoration: underline;
    }

    .dialog-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    label {
      color: #d1d5db;
    }

    textarea {
      background: #020617;
      border-radius: 10px;
      border: 1px solid #374151;
      padding: 10px 12px;
      font-size: 13px;
      color: #e5e7eb;
      resize: vertical;
      min-height: 120px;
    }

    textarea:focus {
      outline: none;
      border-color: #6366f1;
    }

    .actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .result-box {
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 12px;
      max-height: 320px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div>
        <div class="title">Comparador GPT + PDF</div>
        <div class="subtitle">
          O GPT trabalha em segundo plano usando sempre os dados do PDF.
        </div>
      </div>
      <div class="key-box">
        <input
          id="apiKey"
          class="key-input"
          type="password"
          placeholder="Cole aqui sua OPENAI_API_KEY"
        />
        <button id="saveKeyBtn" class="btn">Usar chave</button>
        <div id="status" class="status-pill">sem chave</div>
      </div>
    </div>

    <div class="row">
      <span id="pdfStatus" class="status-pill status-warn">
        carregando PDF de dados...
      </span>
      <span class="hint">
        Modelo: <code>gpt-4.1-mini</code>. A chave e o PDF são usados apenas no seu navegador.
      </span>
    </div>

    <div class="dialog-field">
      <label for="dialogo">
        Janela de diálogo
      </label>
      <textarea
        id="dialogo"
        placeholder="Exemplos:
- Compare a Webcam Logitech C920 com a Brio 100 para aulas online.
- Com base no PDF, qual webcam é melhor para uso em sala de aula?
- Faça um resumo comparativo dos modelos X e Y."
      ></textarea>
    </div>

    <div class="actions">
      <span class="hint">
        O modelo verá sua mensagem + um resumo do PDF e responderá em formato comparativo.
      </span>
      <button id="sendBtn" class="btn">Enviar</button>
    </div>

    <div class="dialog-field">
      <label>Resposta</label>
      <div id="result" class="result-box">
        Aguarde o carregamento do PDF, digite sua pergunta acima e clique em “Enviar”.
      </div>
    </div>
  </div>

  <script type="module">
    /*
      IMPORTAÇÕES:
      - OpenAI SDK via esm.sh
      - pdfjs-dist via JSDelivr para ler o PDF estático "dados.pdf"
    */
    import OpenAI from "https://esm.sh/openai@4.20.0";
    import * as pdfjsLib from "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.mjs";

    // ===== CONFIGURAÇÕES CUSTOMIZÁVEIS =====

    // Caminho do PDF com dados (coloque "dados.pdf" na mesma pasta do index.html)
    const PDF_URL = "dados.pdf";

    // Instruções internas (NÃO aparecem na tela, só vão para o modelo como system message)
   const HIDDEN_INSTRUCTIONS = `
Você é um assistente especializado em comparar itens utilizando obrigatoriamente
as informações fornecidas a partir de um PDF de referência (por exemplo, catálogo técnico,
tabela de especificações ou ficha de produtos).

Regras sobre os dados do PDF:
1. SEMPRE considere o bloco "DADOS DO PDF" que será fornecido na mensagem do usuário. No entanto, o usuário final não pode saber da existência desse PDF. Ele é interno. 
2. Quando houver conflito entre a descrição do usuário e os dados do PDF,
   dê prioridade aos dados do PDF e, se necessário, explique o conflito de forma simples. Não mencione que existe um PDF.
3. Use os dados do PDF para:
   - preencher especificações objetivas (resoluções, dimensões, capacidades, etc.);
   - fundamentar comparações técnicas e de desempenho;
   - evitar inventar números ou características não presentes no PDF.
5. A saída deve ser em português do Brasil.

Estilo da resposta (OBRIGATÓRIO):
1. Responda sempre em, no máximo, 3 frases curtas.
2. A primeira frase deve ser motivadora, mostrando que você entendeu o problema.
3. A segunda e, se necessário, a terceira frase devem:
   - trazer a informação principal pedida; e
   - se fizer sentido, incluir uma pergunta simples para continuar a conversa.
4. Não use tabelas, listas ou formatação Markdown complexa; escreva apenas texto corrido.
5. Seja simples, direto e objetivo, evitando rodeios e explicações muito longas.
6. Sempre inicie a conversa perguntando se você busca um produto mais sofisticado ou simples, com melhor custo-benefício. 
7. Não exponha que está usando uma base de dados em PDF. 
`;

    // ===== ELEMENTOS DE INTERFACE =====

    const apiKeyInput = document.getElementById("apiKey");
    const saveKeyBtn = document.getElementById("saveKeyBtn");
    const statusEl = document.getElementById("status");
    const pdfStatusEl = document.getElementById("pdfStatus");
    const dialogEl = document.getElementById("dialogo");
    const sendBtn = document.getElementById("sendBtn");
    const resultEl = document.getElementById("result");

    // ===== ESTADO =====

    let client = null;
    let hasKey = false;
    let pdfText = "";
    let pdfLoaded = false;

    // ===== CARREGAR CHAVE SALVA (LOCALSTORAGE) =====

    const storedKey = localStorage.getItem("OPENAI_API_KEY_BROWSER");
    if (storedKey) {
      apiKeyInput.value = storedKey;
      initClient(storedKey);
    }

    saveKeyBtn.addEventListener("click", () => {
      const key = apiKeyInput.value.trim();
      if (!key) {
        alert("Cole sua OPENAI_API_KEY antes.");
        return;
      }
      localStorage.setItem("OPENAI_API_KEY_BROWSER", key);
      initClient(key);
    });

    function initClient(key) {
      try {
        client = new OpenAI({
          apiKey: key,
          dangerouslyAllowBrowser: true
        });
        hasKey = true;
        statusEl.textContent = "chave carregada";
        statusEl.classList.add("status-ok");
      } catch (e) {
        console.error(e);
        hasKey = false;
        statusEl.textContent = "erro na chave";
        alert("Erro ao inicializar o cliente. Verifique se a chave está correta.");
      }
    }

    // ===== CARREGAR E LER O PDF =====

    async function loadPdfText() {
      try {
        pdfStatusEl.textContent = "carregando PDF de dados...";
        pdfStatusEl.classList.add("status-warn");

        // worker para o pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.worker.mjs";

        const loadingTask = pdfjsLib.getDocument(PDF_URL);
        const pdf = await loadingTask.promise;

        let fullText = "";

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const content = await page.getTextContent();
          const strings = content.items.map((item) => item.str);
          fullText += strings.join(" ") + "\n";
        }

        // Limita tamanho enviado ao modelo
        const MAX_CHARS = 8000;
        pdfText = fullText.slice(0, MAX_CHARS);

        pdfLoaded = true;
        pdfStatusEl.textContent = "PDF de dados carregado";
        pdfStatusEl.classList.remove("status-warn");
        pdfStatusEl.classList.add("status-ok");

        if (!pdfText.trim()) {
          pdfStatusEl.textContent = "PDF carregado, mas não foi possível extrair texto.";
        }
      } catch (err) {
        console.error("Erro ao carregar/ler o PDF:", err);
        pdfLoaded = false;
        pdfStatusEl.textContent = "erro ao carregar PDF (ver console)";
      }
    }

    // dispara o carregamento assim que a página abrir
    loadPdfText();

    // ===== FUNÇÃO PRINCIPAL (UMA ÚNICA JANELA DE DIÁLOGO) =====

    async function enviarDialogo() {
      if (!hasKey || !client) {
        alert("Configure a chave da OpenAI antes de enviar.");
        return;
      }

      if (!pdfLoaded || !pdfText.trim()) {
        alert("O PDF de dados ainda não foi carregado ou está vazio. Aguarde ou verifique o arquivo dados.pdf.");
        return;
      }

      const textoUsuario = dialogEl.value.trim();
      if (!textoUsuario) {
        alert("Digite uma mensagem na janela de diálogo.");
        return;
      }

      // Construímos a mensagem de usuário juntando:
      // - texto do usuário
      // - bloco com dados do PDF
      const userPrompt = `
Mensagem do usuário:
${textoUsuario}

A seguir estão trechos de texto extraídos de um PDF de referência
(catálogo, tabelas, especificações etc.). Você DEVE usar esses dados
como base principal para qualquer comparação ou análise.

DADOS DO PDF:
${pdfText}
`;

      sendBtn.disabled = true;
      sendBtn.textContent = "Gerando resposta...";
      resultEl.textContent = "Gerando resposta usando sua mensagem e o PDF de dados...";

      try {
        const completion = await client.chat.completions.create({
          model: "gpt-4.1-mini",
          messages: [
            {
              role: "system",
              content: HIDDEN_INSTRUCTIONS
            },
            {
              role: "user",
              content: userPrompt
            }
          ]
        });

        const texto = completion.choices[0]?.message?.content ?? "(resposta vazia)";
        resultEl.textContent = texto;
      } catch (err) {
        console.error(err);
        resultEl.textContent =
          "Ocorreu um erro ao chamar a API. Veja o console do navegador para mais detalhes.";
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "Enviar";
      }
    }

    sendBtn.addEventListener("click", enviarDialogo);

    // Enviar com Ctrl+Enter
    dialogEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        enviarDialogo();
      }
    });
  </script>
</body>
</html>
